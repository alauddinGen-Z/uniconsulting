================================================================================
ENTERPRISE REFACTORING GUIDE
UniConsulting → Global Compass White-Labeling
================================================================================

This document provides complete implementation instructions for the three
critical technical debt fixes required for the Global Compass enterprise demo.

================================================================================
TASK 1: AI CACHING (DATABASE LAYER)
================================================================================

FILES CREATED:
--------------
1. sql/create_ai_query_cache.sql  - Database migration
2. src/lib/ai-cache.ts            - TypeScript caching service

DEPLOYMENT STEPS:
-----------------
1. Run the SQL migration in Supabase SQL Editor:
   - Go to Supabase Dashboard → SQL Editor
   - Paste contents of sql/create_ai_query_cache.sql
   - Click "Run"

2. Verify table creation:
   SELECT * FROM ai_query_cache LIMIT 1;

USAGE EXAMPLE - Integrating with AI Review:
-------------------------------------------
// BEFORE (no caching):
const response = await fetch('/api/ai-review', {
    method: 'POST',
    body: JSON.stringify({ content: essayText })
});
const data = await response.json();

// AFTER (with caching):
import { getOrFetchAIResponse } from '@/lib/ai-cache';

const { data, fromCache } = await getOrFetchAIResponse(
    essayText,              // Content to hash
    'essay_review',         // Query type
    async () => {           // Fetch function (only called on cache miss)
        const res = await fetch('/api/ai-review', {
            method: 'POST',
            body: JSON.stringify({ content: essayText })
        });
        return res.json();
    },
    30                      // TTL in days (optional, default 30)
);

if (fromCache) {
    console.log('Saved an API call! Using cached response.');
}

INTEGRATION POINTS TO UPDATE:
-----------------------------
1. src/components/student/EssaysSubpage.tsx - Wrap AI review calls
2. src/components/teacher/AIMatcherPanel.tsx - Wrap university matcher calls
3. src/app/api/document-ocr/route.ts - Add caching at API level

================================================================================
TASK 2: RELIABILITY & RATE LIMITING
================================================================================

FILE CREATED:
-------------
src/lib/gemini-client.ts - Robust API wrapper with retry logic

RETRY BEHAVIOR:
---------------
Attempt 1: Immediate
Attempt 2: Wait 1 second, retry
Attempt 3: Wait 2 seconds, retry
Attempt 4: Wait 4 seconds, retry (final)
Final Failure: Return clean error, NO 500 crash

TIMEOUT:
--------
60-second timeout using AbortController (configurable)

USAGE EXAMPLE - Replacing Direct Fetch Calls:
---------------------------------------------
// BEFORE (fragile):
const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
    {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ contents: [...] })
    }
);
const result = await response.json();
const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

// AFTER (robust):
import { callGeminiWithRetry, generateText, analyzeImage, GeminiAPIError } from '@/lib/gemini-client';

try {
    // Option 1: Full control
    const text = await callGeminiWithRetry(apiKey, {
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.7, maxOutputTokens: 2048 }
    });
    
    // Option 2: Simple text generation
    const response = await generateText(apiKey, prompt);
    
    // Option 3: Image/document analysis
    const analysis = await analyzeImage(apiKey, prompt, imageBase64, 'image/png');
    
} catch (error) {
    if (error instanceof GeminiAPIError) {
        // User-friendly error message ready for display
        console.error('AI Error:', error.message);
        // error.statusCode, error.retryable available for logic
    }
}

FILES TO UPDATE:
----------------
1. src/app/api/document-ocr/route.ts
   - Replace fetch() with callGeminiWithRetry()

2. src/app/api/ai-review/route.ts
   - Replace model.generateContent() with callGeminiWithRetry()

3. supabase/functions/university-matcher/index.ts
   - Replace fetch() with retry logic (Edge Function version)

4. supabase/functions/ai-review/index.ts
   - Replace fetch() with retry logic

5. supabase/functions/document-ocr/index.ts
   - Replace fetch() with retry logic

================================================================================
TASK 3: THEMING REFACTOR (WHITE-LABELING)
================================================================================

FILES CREATED/MODIFIED:
-----------------------
1. src/lib/theme-config.ts     - Centralized theme presets
2. src/app/globals.css         - CSS variables + Tailwind extension (MODIFIED)

HOW THEMING WORKS:
------------------
1. CSS variables define brand colors in :root
2. Theme classes (.theme-global-compass) override these variables
3. Tailwind utilities (bg-brand-primary-500) use the CSS variables
4. Switching themes = adding a class to <html>

TO ACTIVATE GLOBAL COMPASS (BLUE) THEME:
----------------------------------------
In src/app/layout.tsx, change:

<html lang="en">

To:

<html lang="en" className="theme-global-compass">

Or dynamically:

<html lang="en" data-theme="global-compass">

NEW TAILWIND UTILITIES AVAILABLE:
---------------------------------
bg-brand-primary-50    through    bg-brand-primary-900
bg-brand-secondary-50  through    bg-brand-secondary-900
bg-brand-accent-50     through    bg-brand-accent-900
bg-surface-base, bg-surface-elevated, bg-surface-overlay

text-brand-primary-500, text-brand-secondary-600, etc.
border-brand-primary-300, ring-brand-accent-400, etc.

shadow-brand          (brand-colored shadow)
shadow-brand-lg       (larger brand shadow)
bg-brand-gradient     (primary → secondary gradient)


================================================================================
SEARCH & REPLACE STRATEGY (VS CODE)
================================================================================

Use VS Code's Search & Replace (Ctrl+Shift+H) with Regex enabled.

STEP 1: Replace Orange with Brand Primary
-----------------------------------------
Search (Regex ON):
  \borange-50\b
Replace:
  brand-primary-50

Repeat for all shades (50, 100, 200, 300, 400, 500, 600, 700, 800, 900):

| Search               | Replace                  |
|---------------------|--------------------------|
| \borange-50\b       | brand-primary-50         |
| \borange-100\b      | brand-primary-100        |
| \borange-200\b      | brand-primary-200        |
| \borange-300\b      | brand-primary-300        |
| \borange-400\b      | brand-primary-400        |
| \borange-500\b      | brand-primary-500        |
| \borange-600\b      | brand-primary-600        |
| \borange-700\b      | brand-primary-700        |
| \borange-800\b      | brand-primary-800        |
| \borange-900\b      | brand-primary-900        |

STEP 2: Replace Pink with Brand Secondary
-----------------------------------------
| Search               | Replace                    |
|---------------------|----------------------------|
| \bpink-50\b         | brand-secondary-50         |
| \bpink-100\b        | brand-secondary-100        |
| \bpink-200\b        | brand-secondary-200        |
| \bpink-300\b        | brand-secondary-300        |
| \bpink-400\b        | brand-secondary-400        |
| \bpink-500\b        | brand-secondary-500        |
| \bpink-600\b        | brand-secondary-600        |
| \bpink-700\b        | brand-secondary-700        |
| \bpink-800\b        | brand-secondary-800        |
| \bpink-900\b        | brand-secondary-900        |

STEP 3: Replace Red Accents (for errors, keep as-is or use destructive)
------------------------------------------------------------------------
Keep red-* for error states, OR replace non-error uses:
| Search               | Replace                    |
|---------------------|----------------------------|
| \bred-500\b         | brand-primary-600          |
| \bred-600\b         | brand-primary-700          |

STEP 4: Replace Gradient Patterns
---------------------------------
Search (Regex ON):
  from-orange-(\d+)\s+to-pink-(\d+)
Replace:
  from-brand-primary-$1 to-brand-secondary-$2

Example matches:
  from-orange-500 to-pink-500 → from-brand-primary-500 to-brand-secondary-500

STEP 5: Replace Shadow Colors
-----------------------------
Search (Regex ON):
  shadow-orange-(\d+)(/\d+)?
Replace:
  shadow-brand-primary-$1$2

STEP 6: Update Logo/Branding Text
---------------------------------
Search in: src/components/**
Find: "UNI"
Replace with import from theme-config.ts (see example below)


================================================================================
COMPONENT UPDATE EXAMPLE: DashboardSidebar.tsx
================================================================================

BEFORE:
-------
<div className="w-10 h-10 bg-gradient-to-br from-orange-500 to-pink-500 
     rounded-xl flex items-center justify-center text-white font-black text-xl 
     shadow-lg shadow-orange-500/20">
    U
</div>
<span className="font-black font-montserrat text-2xl tracking-tight text-white">
    UNI
</span>

AFTER (with theming):
---------------------
import { ACTIVE_THEME } from '@/lib/theme-config';

// In render:
<div className="w-10 h-10 bg-brand-gradient
     rounded-xl flex items-center justify-center text-white font-black text-xl 
     shadow-brand">
    {ACTIVE_THEME.branding.logoIcon}
</div>
<span className="font-black font-montserrat text-2xl tracking-tight text-white">
    {ACTIVE_THEME.branding.logoText}
</span>


================================================================================
PRIORITY FILES TO UPDATE (Highest Impact)
================================================================================

1. src/components/student/DashboardSidebar.tsx
   - Logo, nav active states, profile section

2. src/components/teacher/TeacherSidebar.tsx
   - Logo, nav active states, profile section

3. src/app/layout.tsx
   - Add theme class to <html>
   - Update title/description from ACTIVE_THEME

4. src/components/shared/ProfileModal.tsx
   - Button colors, accent colors

5. src/components/student/ApplicationPage.tsx
   - Progress indicators, status badges

6. src/components/teacher/AIMatcherPanel.tsx
   - AI feature accents, loading states


================================================================================
VERIFICATION CHECKLIST
================================================================================

After completing all changes, verify:

□ SQL migration executed successfully (check ai_query_cache table exists)
□ AI caching works (check console for "[AI Cache] HIT" messages)
□ Retry logic works (disconnect network briefly, observe retry messages)
□ Theme switches correctly (add/remove .theme-global-compass class)
□ No hardcoded "orange" remains in component files (search for "orange-")
□ Logo text updates based on ACTIVE_THEME
□ Build passes: npm run build
□ Visual review: All brand colors are consistent blue


================================================================================
QUICK REFERENCE: Color Mapping
================================================================================

OLD (Hardcoded)          | NEW (Semantic)           | Global Compass Value
-------------------------|--------------------------|---------------------
orange-500               | brand-primary-500        | #3b82f6 (blue)
orange-600               | brand-primary-600        | #2563eb (blue)
pink-500                 | brand-secondary-500      | #06b6d4 (cyan)
pink-600                 | brand-secondary-600      | #0891b2 (cyan)
yellow-400               | brand-accent-400         | #4ade80 (green)
slate-900                | surface-base             | #0f172a (unchanged)
slate-800                | surface-elevated         | #1e293b (unchanged)


================================================================================
END OF GUIDE
================================================================================
